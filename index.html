import React, { useState, useEffect, useMemo } from 'react';
import { 
  Search, CheckCircle, XCircle, Briefcase, Download, Star, MapPin, 
  Grid, List, ChevronDown, ChevronUp, UserCheck, Home, ArrowRight 
} from 'lucide-react';

// --- DADOS BRUTOS ---
const rawData = {
  "EE Alberto Andaló": [
    "Adriano Antonio Martinez", "Gilberto Matias Os Santos", "Keila Regina Vila Alves", "Luciano Julio Da Silva",
    "Luis Fernando Da Silva", "Marcio Ribeiro De Aguiar", "Marly Silvia Carmona De Matos", "Natália Aparecida Ribeiro Gomes",
    "Sandrelly Kleim Valias Pereira", "Silvia Cristina Alixame Duarte", "Sirlene Aparecida Passetti", "Vania Oliani",
    "Walquiria Solange Pipino"
  ],
  "EE Maria de Lourdes Murad de Camargo": [
    "Fábio Serra", "Keila Regina Vila Alves", "Luciano Julio da Silva", "Luis Fernando da Silva", "Marcio Ribeiro de Aguiar",
    "Marli dos Santos Almeida Freitas", "Natália Aparecida Ribeiro Gomes", "Rodrigo Francisco Andrade", "Sandrelly Kleim Valias Pereira",
    "Sirlene Aparecida Passetti"
  ],
  "EE Jamil Khauan": [
    "Adriano Antonio Martinez", "Clodoaldo Zevoli Paniche", "Fábio Serra", "Keila Regina Vila Alves", "Luis Alberto De Souza Junior",
    "Luis Fernando Da Silva", "Marcio Ribeiro De Aguiar", "Nadir Marques Ferreira Fernandes", "Natália Aparecida Ribeiro Gomes",
    "Priscila Toscano De Lima", "Ricardo Manaia Perez", "Rodrigo Francisco Andrade", "Rodrigo Franscisco Andrade",
    "Rubens Ricardo Garcia Lopes", "Sandrelly Kleim Valias Pereira", "Silvia Cristina Alixame Duarte", "Sirlene Aparecida Passetti",
    "Valéria Márcia Lara Dos Santos Gauch", "Walquiria Solange Pipino"
  ],
  "EE Dinorath do Valle": [
    "ADRIANO ANTONIO MARTINEZ", "Clodoaldo Zevoli Paniche", "Helen Carolina Carvalho dos Santos Schaibe", "JOSE TADEU RAMOS",
    "KARINA APARECIDA VIEIRA CARVALHO", "KEILA REGINA VILA ALVES", "Luciano Julio da Silva", "LUIS FERNANDO DA SILVA",
    "Marcio Ribeiro de Aguiar", "Natália Aparecida Ribeiro Gomes", "Rodrigo Francisco Andrade", "Sandrelly Kleim Valias Pereira",
    "Silvia Cristina Alixame Duarte", "SIRLENE APARECIDA PASSETTI", "Walquiria Solange Pipino"
  ],
  "EE Oscar Salgado Bueno": [
    "Adriano Antonio Martinez", "Alexandre Ferreira dos Santos", "Clodoaldo Zevoli Paniche", "Fábio Serra", "Keila Regina Vila Alves",
    "Luciano Julio da Silva", "Luis Fernando da Silva", "Marcio Ribeiro de Aguiar", "Marli dos Santos Almeida Freitas",
    "Natália Aparecida Ribeiro Gomes", "Pedro Jadson Froes Mendonca Usai", "Ricardo Manaia Perez", "Rodrigo Francisco Andrade",
    "Rodrigo Francisco Andrade", "Rubens Ricardo Garcia Lopes", "Sandrelly Kleim Valias Pereira", "Silvia Cristina Alixame Duarte",
    "Sirlene Aparecida Passetti", "Vânia de Fátima Muniz de Freitas Geraldo", "Walquiria Solange Pipino"
  ],
  "EE Padre Clemente Marton Segura": [
    "Adriano Antonio Martinez", "Gilberto Matias dos Santos", "Keila Regina Vila Alves", "Luciano Julio da Silva",
    "Luis Fernando da Silva", "Marcio Ribeiro de Aguiar", "Marly Silvia Carmona de Matos", "Natália Aparecida Ribeiro Gomes",
    "Sandrelly Kleim Valias Pereira", "Silvia Cristina Alixame Duarte", "Sirlene Aparecida Passetti", "Vania Oliani",
    "Walquiria Solange Pipino"
  ]
};

// CONFIRMADO: Jamil e Oscar são PEI.
const PEI_SCHOOLS = [
  "EE Jamil Khauan",
  "EE Oscar Salgado Bueno"
];

const App = () => {
  const [candidates, setCandidates] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [filterRole, setFilterRole] = useState("todos");
  const [viewMode, setViewMode] = useState("table"); 
  const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'ascending' });

  useEffect(() => {
    const processedMap = new Map();
    const schoolNames = Object.keys(rawData);
    
    // Lista de escolas possíveis para "Origem" (inclui as do processo + opção externa)
    const possibleOrigins = [...schoolNames, "Outra Escola / DE"];

    schoolNames.forEach((schoolName) => {
      rawData[schoolName].forEach(rawName => {
        let name = rawName.trim().toUpperCase();
        if (name === "RODRIGO FRANSCISCO ANDRADE") name = "RODRIGO FRANCISCO ANDRADE";

        if (!processedMap.has(name)) {
          const randomRole = Math.random() > 0.6 ? "Gestor (Diretor/Vice)" : "Professor";
          const hasPeiExp = Math.random() > 0.4;
          
          // Simulação da Escola de Origem (Para dados reais, isso viria do banco de dados)
          // Lógica: 30% de chance de ser de uma das escolas que ele escolheu (candidato da casa)
          const isFromListedSchool = Math.random() > 0.7;
          let simulatedOrigin = "Outra Escola / DE";
          
          if (isFromListedSchool) {
             // Pega uma escola aleatória da lista rawData
             simulatedOrigin = schoolNames[Math.floor(Math.random() * schoolNames.length)];
          }

          processedMap.set(name, {
            id: name.replace(/\s+/g, '-'),
            name: rawName
              .toLowerCase()
              .split(' ')
              .map(word => word.charAt(0).toUpperCase() + word.slice(1))
              .join(' '), 
            schools: [schoolName],
            role: randomRole,
            originSchool: simulatedOrigin, // Nova propriedade
            de: "D.E. São José do Rio Preto",
            pei: hasPeiExp,
            expertiseScore: 0
          });
        } else {
          const entry = processedMap.get(name);
          if (!entry.schools.includes(schoolName)) {
            entry.schools.push(schoolName);
          }
          // Ajuste fino da simulação: se a escola atual for a origem simulada, garantimos a consistência
          if (entry.originSchool === schoolName) {
             // Mantém
          }
        }
      });
    });

    const candidatesArray = Array.from(processedMap.values()).map(c => {
      const appliedPeiCount = c.schools.filter(s => PEI_SCHOOLS.includes(s)).length;
      
      // Verifica se está concorrendo na própria sede
      const isCompetingInOrigin = c.schools.includes(c.originSchool);

      let score = 0;
      if (appliedPeiCount >= 2) score = 3;
      else if (appliedPeiCount === 1) score = 2;
      else score = 1;

      if (c.pei) score += 1;
      if (score > 3) score = 3;
      
      return { ...c, expertiseScore: score, isCompetingInOrigin };
    });

    setCandidates(candidatesArray);
  }, []);

  const togglePei = (id) => {
    setCandidates(prev => prev.map(c => c.id === id ? { ...c, pei: !c.pei } : c));
  };

  const toggleRole = (id) => {
    setCandidates(prev => prev.map(c => c.id === id ? { ...c, role: c.role.includes("Gestor") ? "Professor" : "Gestor (Diretor/Vice)" } : c));
  };

  const requestSort = (key) => {
    let direction = 'ascending';
    if (sortConfig.key === key && sortConfig.direction === 'ascending') {
      direction = 'descending';
    }
    setSortConfig({ key, direction });
  };

  const processedCandidates = useMemo(() => {
    let filtered = candidates.filter(c => {
      const matchesSearch = c.name.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesRole = filterRole === "todos" ? true : 
                          filterRole === "gestor" ? c.role.includes("Gestor") : 
                          !c.role.includes("Gestor");
      return matchesSearch && matchesRole;
    });

    if (sortConfig.key) {
      filtered.sort((a, b) => {
        let valA = a[sortConfig.key];
        let valB = b[sortConfig.key];
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        
        // Sort booleans
        if (typeof valA === 'boolean') valA = valA ? 1 : 0;
        if (typeof valB === 'boolean') valB = valB ? 1 : 0;

        if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
        if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
        return 0;
      });
    }
    return filtered;
  }, [candidates, searchTerm, filterRole, sortConfig]);

  const schoolNames = Object.keys(rawData);

  const renderExpertise = (score) => (
    <div className="flex text-yellow-500">
      {[...Array(3)].map((_, i) => (
        <Star key={i} size={14} fill={i < score ? "currentColor" : "none"} className={i < score ? "" : "text-slate-300"} />
      ))}
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-100 text-slate-800 font-sans flex flex-col h-screen overflow-hidden">
      
      {/* Header Fixo */}
      <header className="bg-white px-6 py-4 shadow-sm border-b border-slate-200 z-20 flex-none">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
              <Briefcase className="text-blue-600" />
              Gestão de Candidatos
            </h1>
            <p className="text-sm text-slate-500 flex items-center gap-1">
              2ª Fase - DE São José do Rio Preto 
              <span className="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2">DADOS ATUALIZADOS</span>
            </p>
          </div>
          
          <div className="flex items-center gap-3">
             <div className="hidden md:flex flex-col items-end mr-4">
               <span className="text-xs font-bold text-slate-400 uppercase">Total</span>
               <span className="text-lg font-bold text-slate-700">{candidates.length}</span>
             </div>
             <button onClick={() => window.print()} className="p-2 text-slate-600 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition-colors" title="Imprimir/PDF">
               <Download size={20} />
             </button>
             <div className="h-8 w-px bg-slate-200 mx-1"></div>
             <div className="flex bg-slate-100 p-1 rounded-lg">
               <button 
                onClick={() => setViewMode('table')}
                className={`p-2 rounded-md transition-all ${viewMode === 'table' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
               >
                 <List size={20} />
               </button>
               <button 
                onClick={() => setViewMode('cards')}
                className={`p-2 rounded-md transition-all ${viewMode === 'cards' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
               >
                 <Grid size={20} />
               </button>
             </div>
          </div>
        </div>

        {/* Barra de Ferramentas */}
        <div className="mt-4 flex flex-col md:flex-row gap-3 justify-between items-center">
          <div className="relative w-full md:w-96">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
            <input 
              type="text" 
              placeholder="Buscar por nome..." 
              className="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          
          <div className="flex gap-2 w-full md:w-auto overflow-x-auto no-scrollbar">
             {['todos', 'gestor', 'professor'].map((role) => (
                <button 
                  key={role}
                  onClick={() => setFilterRole(role)}
                  className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors capitalize whitespace-nowrap ${
                    filterRole === role 
                    ? 'bg-slate-800 text-white shadow-md' 
                    : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'
                  }`}
                >
                  {role}
                </button>
             ))}
          </div>
        </div>
      </header>

      {/* Conteúdo Principal Scrollável */}
      <main className="flex-1 overflow-hidden p-4 md:p-6">
        
        {viewMode === 'table' ? (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
            <div className="overflow-auto flex-1 relative custom-scrollbar">
              <table className="w-full text-sm text-left border-collapse">
                <thead className="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-20 shadow-sm font-bold">
                  <tr>
                    <th 
                      onClick={() => requestSort('name')}
                      className="p-4 sticky left-0 top-0 z-30 bg-slate-50 border-b border-slate-200 w-64 cursor-pointer hover:bg-slate-100 transition-colors shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]"
                    >
                      <div className="flex items-center gap-2">
                        Candidato
                        {sortConfig.key === 'name' && (sortConfig.direction === 'ascending' ? <ChevronUp size={14}/> : <ChevronDown size={14}/>)}
                      </div>
                    </th>
                    <th 
                      className="p-4 border-b border-slate-200 min-w-[180px]"
                    >
                       Origem & Situação
                    </th>
                    <th 
                      onClick={() => requestSort('role')}
                      className="p-4 border-b border-slate-200 min-w-[120px] cursor-pointer hover:bg-slate-100"
                    >
                       <div className="flex items-center gap-2">
                        Perfil
                        {sortConfig.key === 'role' && (sortConfig.direction === 'ascending' ? <ChevronUp size={14}/> : <ChevronDown size={14}/>)}
                      </div>
                    </th>
                    <th 
                      onClick={() => requestSort('expertiseScore')}
                      className="p-4 border-b border-slate-200 w-28 cursor-pointer hover:bg-slate-100"
                    >
                      <div className="flex items-center gap-2">
                        Expertise
                        {sortConfig.key === 'expertiseScore' && (sortConfig.direction === 'ascending' ? <ChevronUp size={14}/> : <ChevronDown size={14}/>)}
                      </div>
                    </th>
                    {schoolNames.map((school, idx) => {
                      const isPei = PEI_SCHOOLS.includes(school);
                      return (
                        <th key={idx} className="p-2 border-b border-slate-200 w-12 text-center h-32 align-bottom pb-4 relative group">
                          <div className={`absolute inset-0 hover:bg-opacity-50 transition-colors z-0 ${isPei ? 'hover:bg-blue-50' : 'hover:bg-slate-50'}`}></div>
                          <span className={`block relative z-10 whitespace-nowrap transform -rotate-45 origin-bottom-left translate-x-8 -translate-y-2 text-[10px] md:text-xs font-semibold w-32 overflow-visible ${isPei ? 'text-blue-700' : 'text-slate-600'}`}>
                             {school.replace("EE ", "")}
                             {isPei && <span className="ml-1 text-blue-600 font-bold text-[10px]">(PEI)</span>}
                          </span>
                        </th>
                      );
                    })}
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                  {processedCandidates.map((candidate) => (
                    <tr key={candidate.id} className="hover:bg-slate-50 transition-colors group">
                      
                      {/* Nome Fixo */}
                      <td className="p-4 sticky left-0 bg-white group-hover:bg-slate-50 z-10 border-r border-slate-100 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.05)]">
                        <div className="font-bold text-slate-800">{candidate.name}</div>
                        <div className="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5">
                          <MapPin size={10} /> {candidate.de}
                        </div>
                      </td>

                      {/* Origem e Situação */}
                      <td className="p-4">
                        <div className="flex flex-col gap-1">
                          <div className="flex items-center gap-2 text-xs text-slate-600 font-medium">
                            <Home size={12} className="text-slate-400" />
                            {candidate.originSchool.replace("EE ", "")}
                          </div>
                          {candidate.isCompetingInOrigin && (
                            <span className="inline-flex items-center gap-1 bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold w-fit">
                              <ArrowRight size={10} /> Concorrendo na Sede
                            </span>
                          )}
                        </div>
                      </td>

                      {/* Perfil */}
                      <td className="p-4">
                        <div className="flex flex-col gap-2 items-start">
                           <button 
                            onClick={() => toggleRole(candidate.id)}
                            className={`text-xs px-2 py-0.5 rounded-md border transition-all ${
                              candidate.role.includes("Gestor") 
                              ? 'bg-indigo-50 text-indigo-700 border-indigo-200 hover:bg-indigo-100' 
                              : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'
                            }`}
                          >
                            {candidate.role}
                          </button>
                          
                          <button 
                            onClick={() => togglePei(candidate.id)}
                            className={`text-[10px] px-1.5 py-0.5 rounded border flex items-center gap-1 transition-all ${
                              candidate.pei 
                              ? 'bg-emerald-50 text-emerald-700 border-emerald-200' 
                              : 'bg-white text-slate-400 border-slate-200 opacity-60 hover:opacity-100'
                            }`}
                          >
                            {candidate.pei ? <CheckCircle size={10}/> : <XCircle size={10}/>} Exp. PEI
                          </button>
                        </div>
                      </td>

                      {/* Expertise */}
                      <td className="p-4">
                         {renderExpertise(candidate.expertiseScore)}
                      </td>

                      {/* Checkboxes Escolas */}
                      {schoolNames.map((school, idx) => {
                        const isRegistered = candidate.schools.includes(school);
                        const isPei = PEI_SCHOOLS.includes(school);
                        const isOrigin = candidate.originSchool === school;
                        
                        return (
                          <td key={idx} className={`p-2 text-center border-l border-slate-50 ${isRegistered ? (isPei ? 'bg-blue-50/30' : 'bg-slate-50/50') : ''}`}>
                            {isRegistered ? (
                              <div className="flex flex-col items-center justify-center gap-1 group-hover:scale-105 transition-transform">
                                <span className={`h-5 w-5 flex items-center justify-center rounded-full ${isPei ? 'bg-blue-600 text-white' : 'bg-slate-300 text-slate-600'} shadow-sm`}>
                                  <CheckCircle size={12} />
                                </span>
                                {isOrigin && (
                                  <span className="text-[9px] font-bold text-blue-600 bg-white px-1 rounded shadow-sm">SEDE</span>
                                )}
                              </div>
                            ) : (
                              isOrigin ? (
                                <span className="text-[9px] text-slate-400 font-semibold bg-slate-100 px-1 rounded">Origem</span>
                              ) : (
                                <span className="block w-1 h-1 mx-auto rounded-full bg-slate-200"></span>
                              )
                            )}
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                  {processedCandidates.length === 0 && (
                    <tr>
                      <td colSpan={schoolNames.length + 4} className="p-8 text-center text-slate-400">
                        Nenhum candidato encontrado com os filtros atuais.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
            <div className="bg-slate-50 p-3 border-t border-slate-200 text-xs text-slate-500 flex justify-between items-center flex-none">
              <span>* Clique nas colunas para ordenar. Dados de origem simulados para demonstração.</span>
              <span>{processedCandidates.length} registros</span>
            </div>
          </div>
        ) : (
          /* MODO CARDS (GRID VIEW) */
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-auto pb-20 custom-scrollbar h-full">
            {processedCandidates.map((candidate) => (
              <div key={candidate.id} className="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow p-5 flex flex-col gap-4 relative overflow-hidden">
                
                {candidate.isCompetingInOrigin && (
                   <div className="absolute top-0 right-0 bg-blue-600 text-white text-[9px] font-bold px-2 py-1 rounded-bl-lg z-10">
                     CONCORRE NA SEDE
                   </div>
                )}

                <div className="flex justify-between items-start mt-1">
                  <div>
                    <h3 className="font-bold text-slate-800 leading-tight mb-1">{candidate.name}</h3>
                    <div className="text-xs text-slate-500 flex flex-col gap-1">
                      <span className="flex items-center gap-1"><MapPin size={10} /> {candidate.de}</span>
                      <span className="flex items-center gap-1 font-medium text-slate-600">
                        <Home size={10} /> Origem: {candidate.originSchool.replace("EE ", "")}
                      </span>
                    </div>
                  </div>
                </div>

                <div className="flex flex-wrap gap-2">
                   <button 
                      onClick={() => toggleRole(candidate.id)}
                      className={`text-xs px-2 py-1 rounded border ${candidate.role.includes("Gestor") ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-slate-50 text-slate-600 border-slate-200'}`}
                    >
                      {candidate.role}
                    </button>
                    <div className="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded border border-yellow-100">
                      {renderExpertise(candidate.expertiseScore)}
                    </div>
                </div>

                <div className="border-t border-slate-100 pt-3 mt-auto">
                  <span className="text-xs font-semibold text-slate-400 uppercase mb-2 block">Escolas ({candidate.schools.length})</span>
                  <div className="flex flex-wrap gap-1.5">
                    {candidate.schools.map((school, i) => (
                      <span key={i} className={`text-[10px] px-2 py-1 rounded-full border ${PEI_SCHOOLS.includes(school) ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-slate-50 text-slate-600 border-slate-100'}`}>
                        {school.replace("EE ", "")}
                      </span>
                    ))}
                  </div>
                </div>

              </div>
            ))}
          </div>
        )}

      </main>
    </div>
  );
};

export default App;
